<% layout('/layouts/boilerplate') -%>
<%- include('../partials/form') %> 
<section class="show-wrapper">
  <div class="stay-details">

    <div class="stay-info">
      <div class="stay-title">
        <h2> <%= stay.title %> </h2>
        <p class="muted stay-details__location"><%= stay.location %>. </p>
      </div>
      <div class="container__show-image">
        <img src="<%=stay.image%>" alt="">
        <p role="heading" class="stay-details__price">$<b class="price"><%=parseFloat(stay.price)%></b>/night</p>
      </div>
      <p class= "stay-details__description"><%=stay.description%></p>
      <a class="update-form__link" href='/stays/<%=stay._id%>/update'>Update Listing</a>
      <form action="/stays/<%=stay._id%>?_method=DELETE" method="POST" class="stay-delete_form">
        <button class="delete-button">Remove listing</button>
      </form>
    </div>

    <div class="book-form_container">
      <form action="/stays/<%=stay._id%>/bookings" method='POST' class="book-form <%=bookErrors[0]%>" id="booking" novalidate>
        <div class="booking-info">
          <div class="form-group">
          <label for="lodge-in" class="lodge-label lodge-in-label">Lodge-in</label>
          <p class="lodge-date_str lodge-in-date <%=checkIn?'selected-date':''%>">
            <%= checkIn||'check-in-date'%>
          </p>
          <input type="hidden" value="<%=checkInDate%>" name="lodgeIn" id="lodge-in" class="lodgeDate" required>
          </div>
          <div class="form-group">
          <label for="lodge-out" class="lodge-label lodge-out-label">Lodge-out</label>
          <p class="lodge-date_str lodge-out-date <%=checkOut?'selected-date':''%>">
            <%=checkOut||'check-out-date'%>
          </p>
          <input type="hidden" name="lodgeOut" value="<%=checkOutDate%>" id="lodge-out" class="lodgeDate" required>
          </div>
          <div class="book-price form-group">
            <p class="totalPrice-label">Total Price</p>
            <p class="totalPrice"></p>
            <input type="hidden" name="totalFee" id="totalFee" required>
          </div>
        </div>
        <button type="submit" class="book-btn">Book</button> 
      </form>
      <% if(bookErrors.length > 0) { %> 
        <% for(let i = 1; i < bookErrors.length; i++){ %>   
        <small class="validity-feedback invalid"><%=bookErrors[i]%></small>
        <% } %>  
    <% } %> 
    </div>

  </div>

 <div class="reviews-container">
    <% if(reviews.length) { %>
    <h2>Ratings & Reviews</h2>
    <p role="doc-tip" aria-roledescription="average-rating" class="average-rating">
      <svg viewBox="0 0 1000 1000" role="presentation" aria-hidden="true" focusable="false" style="height: 14px; width: 14px; fill:  #fd705d;"><path d="M972 380c9 28 2 50-20 67L725 619l87 280c11 39-18 75-54 75-12 0-23-4-33-12L499 790 273 962a58 58 0 0 1-78-12 50 50 0 0 1-8-51l86-278L46 447c-21-17-28-39-19-67 8-24 29-40 52-40h280l87-279c7-23 28-39 52-39 25 0 47 17 54 41l87 277h280c24 0 45 16 53 40z"></path></svg> <%= stay.rating?.toFixed(2) %> 
      <span>(<%= stay.reviews.length %> <% if(stay.reviews.length >1) {%>reviews <% }else{ %>review <% } %>   ) </span>
    </p>     
    <div class="reviews">
        <% for (let i = 0; i < 5 ; i++){ %>
          <% if(reviews[i]) {%>
        <div class="review">
          <p>Rating: <%=reviews[i].rating%></p>
          <p>Comment: <%= reviews[i].comment %></p>
          <p>
            <form action="/stays/<%=stay._id%>/reviews/<%=reviews[i]._id%>?_method=DELETE" method="POST">
              <button class="review-delete">Delete</button>
            </form>
          </p>
        </div>
        <% } %>
        <% } %>  
      </div>

      <label class="show-reviews" for="show-radio">Show all <%=reviews.length%>  reviews &#10095;</label>
      <input type="radio"  name="toggle-review" id="show-radio">
      
      <div class="modal-cover"></div>
      <div class="reviews-modal">
        <h2> 
          <span> 
            <svg viewBox="0 0 1000 1000" role="presentation" aria-hidden="true" focusable="false" style="height: 14px; width: 14px; fill:  #fd705d;"><path d="M972 380c9 28 2 50-20 67L725 619l87 280c11 39-18 75-54 75-12 0-23-4-33-12L499 790 273 962a58 58 0 0 1-78-12 50 50 0 0 1-8-51l86-278L46 447c-21-17-28-39-19-67 8-24 29-40 52-40h280l87-279c7-23 28-39 52-39 25 0 47 17 54 41l87 277h280c24 0 45 16 53 40z"></path></svg>
          </span> <%= stay.rating?.toFixed(2) %> &bull; <%=reviews.length%>  reviews
        </h2>
        <div class="modal-review">
        <% for (let i = 0; i < reviews.length ; i++){ %>
          <div class="review">
            <p>Rating: <%=reviews[i].rating%></p>
            <p>Comment: <%= reviews[i].comment %></p>
            <p>
              <form action="/stays/<%=stay._id%>/reviews/<%=reviews[i]._id%>?_method=DELETE" method="POST">
                <button class="review-delete">Delete</button>
              </form>
            </p>
          </div>
          <% } %> 
        </div>
        <label class="hide-reviews" for="hide-radio"><span>&#10006;</span></label>
        <input type="radio" name="toggle-review" id="hide-radio">        
      </div>
      <% } %> 

      <div class="review-form_container">
        <h2>Leave a Review</h2>
        <form action="/stays/<%=stay._id%>/reviews" id="review-form" class="<%=reviewErrors[0]%> post-form" method="POST" class="post-form" novalidate>
          <div class="review-form">
            <label for="rating">Rating</label>
            <input type="range" name="rating" class="review-form_input" id="rating" step="0.1" min="1" max="5" value="1" required>
          </div>
          <div class="review-form">
            <label for="comment">Comment</label>
            <textarea name="comment" id="comment" minlength="2" title="must contain at least 2 characters" class="review-form_input form_input" cols="20" rows="10" required></textarea>
            <small class="validity-feedback"><%=reviewErrors[2]%></small>
          </div>
          <button class="review-form_button">Submit</button>
        </form>
      </div>
  </div>

</section>

<% block('calendar').append('<script src="/scripts/calendar.js"></script>') %>
<% block('script').append('<script src="/scripts/script.js"></script>') %>